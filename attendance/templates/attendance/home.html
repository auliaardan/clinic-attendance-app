<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Absensi Klinik</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body {
            background: #f4f6f9;
        }

        .btn-in {
            background: #0d6efd;
            border-color: #0d6efd;
            color: #fff;
        }

        .btn-out {
            background: #dc3545;
            border-color: #dc3545;
            color: #fff;
        }

        .app-container {
            max-width: 480px;
            margin: auto;
            padding: 12px;
        }

        .card {
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }

        #reader {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
        }

        .action-btn.active {
            background: #0d6efd;
            color: white;
        }

        .status-small {
            font-size: 13px;
            color: #666;
        }

        #result {
            margin-top: 10px;
            font-weight: 500;
        }
    </style>
</head>

<body>
<div class="app-container">

    <!-- HEADER -->
    <div class="text-center mb-3">
        <h3 class="fw-bold mb-0">Absensi Klinik</h3>
        <div class="text-muted small">Scan QR • Selfie • PIN</div>
    </div>

    <!-- STATUS + SINGLE ACTION -->
    <div class="card p-3 mb-3">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <div class="small text-muted mb-1">Status Staff</div>
                <div class="fw-semibold" id="staffStatusText">Pilih staff…</div>
                <div class="status-small" id="staffStatusSince"></div>
            </div>
            <span class="badge text-bg-secondary" id="staffStatusBadge">-</span>
        </div>

        <button class="btn w-100 mt-3" id="actionBtn" type="button" onclick="submitClock()" disabled>
            Pilih staff dulu
        </button>

        <div class="status-small mt-2" id="actionLabel">Next action: -</div>
    </div>


    <!-- QR CARD -->
    <div class="card p-3 mb-3">
        <h6 class="fw-bold mb-2">1) Scan QR</h6>
        <div id="reader" class="mb-2"></div>

        <div class="status-small">QR token: <span id="qrToken">-</span></div>
        <div class="status-small">Status: <span id="qrStatus">Not scanned</span></div>
        <div class="status-small">Expires: <span id="qrCountdown">-</span></div>

        <button class="btn btn-sm btn-secondary mt-2" type="button" onclick="forceRescan()">
            Rescan QR
        </button>
    </div>

    <!-- FORM CARD -->
    <div class="card p-3 mb-3">
        <h6 class="fw-bold mb-3">2) Isi Data</h6>

        <div class="mb-2">
            <label class="form-label">Mode</label>
            <select id="mode" class="form-select" onchange="toggleProxy()">
                <option value="normal">Normal</option>
                <option value="proxy">Clock untuk orang lain (Proxy)</option>
            </select>
        </div>

        <div class="mb-2">
            <label class="form-label">Nama Staff</label>
            <select id="subject_employee_id" class="form-select" onchange="refreshStatus()">
                {% for e in employees %}
                    <option value="{{ e.id }}">{{ e.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">PIN Staff</label>
            <input id="subject_pin" class="form-control" type="password" inputmode="numeric" placeholder="PIN"/>
        </div>

        <div id="proxyBox" style="display:none;">
            <div class="mb-2">
                <label class="form-label">Saksi</label>
                <select id="witness_employee_id" class="form-select">
                    {% for e in employees %}
                        <option value="{{ e.id }}">{{ e.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">PIN Saksi</label>
                <input id="witness_pin" class="form-control" type="password" inputmode="numeric"
                       placeholder="PIN saksi"/>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Selfie</label>
            <input id="photo" class="form-control" type="file" accept="image/*" capture="user"/>
        </div>

        <button class="btn btn-success w-100" onclick="submitClock()">
            Submit Absensi
        </button>

        <div id="result" class="text-center"></div>
    </div>

</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script>
    // ======= State =======
    let currentAction = "IN";
    let scannedToken = "";
    let countdownTimer = null;
    let expiresIn = 0;

    const html5QrCode = new Html5Qrcode("reader");
    let scanning = false;

    window.addEventListener("load", () => {
        startScanning();
        refreshStatus();
    });

    // ======= UI helpers =======
    function setAction(a) {
        currentAction = a;

        const actionBtn = document.getElementById("actionBtn");
        const actionLabel = document.getElementById("actionLabel");

        if (a === "IN") {
            actionBtn.classList.remove("btn-out");
            actionBtn.classList.add("btn-in");
            actionBtn.textContent = "Clock In";
            actionLabel.textContent = "Next action: IN";
        } else {
            actionBtn.classList.remove("btn-in");
            actionBtn.classList.add("btn-out");
            actionBtn.textContent = "Clock Out";
            actionLabel.textContent = "Next action: OUT";
        }
    }


    function toggleProxy() {
        const isProxy = document.getElementById("mode").value === "proxy";
        document.getElementById("proxyBox").style.display = isProxy ? "block" : "none";
    }

    function setQRUI(status, secondsLeft) {
        document.getElementById("qrStatus").textContent = status;
        document.getElementById("qrCountdown").textContent =
            (secondsLeft != null) ? (secondsLeft + "s") : "-";
    }

    function setResult(msg) {
        document.getElementById("result").textContent = msg || "";
    }

    // ======= Countdown (server-synced seconds) =======
    function stopCountdown() {
        if (countdownTimer) clearInterval(countdownTimer);
        countdownTimer = null;
    }

    function startCountdown(secondsLeft) {
        stopCountdown();
        expiresIn = Number(secondsLeft || 0);

        setQRUI("Valid (server)", expiresIn);

        countdownTimer = setInterval(() => {
            expiresIn = Math.max(0, expiresIn - 1);
            setQRUI(expiresIn > 0 ? "Valid (server)" : "Expired — rescan", expiresIn);

            if (expiresIn <= 0) {
                scannedToken = "";
                stopCountdown();
                // resume scanning automatically when expired
                startScanning();
            }
        }, 1000);
    }

    // ======= QR validation (asks server) =======
    async function validateScannedToken(token) {
        const res = await fetch(`/api/qr/check/?token=${encodeURIComponent(token)}`);
        return await res.json(); // { valid, expires_in, ... }
    }

    // ======= Scanner control =======
    async function startScanning() {
        if (scanning) return;

        // If we already have a valid token, don't scan again
        if (scannedToken) return;

        scanning = true;
        try {
            const config = {fps: 10, qrbox: 250};
            await html5QrCode.start(
                {facingMode: "environment"},
                config,
                async (decodedText) => {
                    // Pause scanning immediately to prevent repeated rescans
                    await stopScanning();
                    await handleScan(decodedText);
                }
            );
        } catch (e) {
            scanning = false;
            setQRUI("Camera error — allow permission & reload", null);
        }
    }

    async function stopScanning() {
        if (!scanning) return;
        scanning = false;
        try {
            await html5QrCode.stop();
            await html5QrCode.clear();
        } catch (e) {
            // ignore stop/clear errors
        }
    }

    // ======= Scan handler (single-shot) =======
    async function handleScan(decodedText) {
        const token = (decodedText || "").trim();
        if (!token) {
            setQRUI("Scan failed — try again", null);
            startScanning();
            return;
        }

        // Show token + checking
        scannedToken = token;
        document.getElementById("qrToken").textContent = token.slice(0, 20) + "...";
        setQRUI("Checking…", null);

        try {
            const check = await validateScannedToken(token);

            if (!check.valid) {
                scannedToken = "";
                stopCountdown();
                setQRUI("Expired/invalid — scan again", 0);
                startScanning();
                return;
            }

            // Valid token — start synchronized countdown
            startCountdown(check.expires_in);

            // Do NOT resume scanning while token is valid.
            // Rescan happens via button or when token expires.
        } catch (e) {
            scannedToken = "";
            stopCountdown();
            setQRUI("Network error — try scan again", null);
            startScanning();
        }
    }

    // ======= Rescan button =======
    async function forceRescan() {
        scannedToken = "";
        stopCountdown();
        document.getElementById("qrToken").textContent = "-";
        setQRUI("Not scanned", null);
        setResult("");
        await startScanning();
    }

    async function resizeImage(file, maxSide = 1024, quality = 0.75) {
        const img = new Image();
        const url = URL.createObjectURL(file);

        try {
            await new Promise((resolve, reject) => {
                img.onload = resolve;
                img.onerror = reject;
                img.src = url;
            });

            let {width, height} = img;
            const longest = Math.max(width, height);
            if (longest > maxSide) {
                const scale = maxSide / longest;
                width = Math.round(width * scale);
                height = Math.round(height * scale);
            }

            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            const blob = await new Promise((resolve) =>
                canvas.toBlob(resolve, "image/jpeg", quality)
            );
            return blob;
        } finally {
            URL.revokeObjectURL(url);
        }
    }

    // ======= Submit =======
    async function submitClock() {
        const mode = document.getElementById("mode").value;
        const isProxy = mode === "proxy";

        const subjectId = document.getElementById("subject_employee_id").value;
        const subjectPin = document.getElementById("subject_pin").value;

        const witnessId = document.getElementById("witness_employee_id").value;
        const witnessPin = document.getElementById("witness_pin").value;

        const photoFile = document.getElementById("photo").files[0];
        const resizedBlob = await resizeImage(photoFile, 1024, 0.75); // maxSide=1024, quality=0.75


        if (!scannedToken) {
            setResult("❌ Scan QR dulu.");
            return;
        }
        if (!subjectPin) {
            setResult("❌ PIN staff wajib.");
            return;
        }
        if (!photoFile) {
            setResult("❌ Selfie wajib.");
            return;
        }
        if (isProxy && !witnessPin) {
            setResult("❌ PIN saksi wajib (proxy).");
            return;
        }

        const form = new FormData();
        form.append("action", currentAction);
        form.append("qr_token", scannedToken);
        form.append("subject_employee_id", subjectId);
        form.append("subject_pin", subjectPin);
        form.append("photo", resizedBlob, "selfie.jpg");
        form.append("is_proxy", isProxy ? "1" : "0");

        if (isProxy) {
            form.append("witness_employee_id", witnessId);
            form.append("witness_pin", witnessPin);
        }

        try {
            const resp = await fetch("/api/clock/", {method: "POST", body: form});
            const data = await resp.json();

            if (data.ok) {
                setResult("✅ " + data.message + " @ " + data.time);
                // Reset for next user
                scannedToken = "";
                stopCountdown();
                document.getElementById("qrToken").textContent = "-";
                setQRUI("Not scanned", null);
                document.getElementById("photo").value = "";
                startScanning();
                await refreshStatus();

            } else {
                setResult("❌ " + (data.error || "Error"));
                // If QR expired at submit time, force rescan
                if ((data.error || "").toLowerCase().includes("qr")) {
                    scannedToken = "";
                    stopCountdown();
                    setQRUI("Expired/invalid — scan again", 0);
                    startScanning();
                }
            }
        } catch (e) {
            setResult("❌ Network error");
        }
    }

    // ======= Start scanning on load =======
    // Note: some browsers require user gesture; if so, press Rescan.
    window.addEventListener("load", () => {
        startScanning();
    });

    function setStaffStatusUI({employeeName, currentState, sinceISO}) {
        const badge = document.getElementById("staffStatusBadge");
        const text = document.getElementById("staffStatusText");
        const since = document.getElementById("staffStatusSince");

        if (!employeeName) {
            badge.className = "badge text-bg-secondary";
            badge.textContent = "-";
            text.textContent = "Pilih staff…";
            since.textContent = "";
            return;
        }

        if (currentState === "IN") {
            badge.className = "badge text-bg-success";
            badge.textContent = "SEDANG BEKERJA";
            text.textContent = `${employeeName} • Sudah Clock In`;
        } else {
            badge.className = "badge text-bg-secondary";
            badge.textContent = "BELUM CLOCK IN";
            text.textContent = `${employeeName} • Belum Clock In`;
        }

        if (sinceISO) {
            const dt = new Date(sinceISO);
            since.textContent = "Sejak: " + dt.toLocaleString();
        } else {
            since.textContent = "";
        }
    }

    async function refreshStatus() {
        const subjectId = document.getElementById("subject_employee_id").value;
        const actionBtn = document.getElementById("actionBtn");

        if (!subjectId) {
            actionBtn.disabled = true;
            actionBtn.textContent = "Pilih staff dulu";
            setStaffStatusUI({employeeName: null});
            return;
        }

        try {
            const res = await fetch(`/api/employee/status/?employee_id=${encodeURIComponent(subjectId)}`);
            const data = await res.json();

            if (!data.ok) {
                actionBtn.disabled = true;
                setStaffStatusUI({employeeName: null});
                setResult("❌ " + (data.error || "Gagal ambil status staff"));
                return;
            }

            // current_state: IN/OUT, next_action: IN/OUT
            setStaffStatusUI({
                employeeName: data.employee_name,
                currentState: data.current_state,
                sinceISO: data.since,
            });

            setAction(data.next_action);
            actionBtn.disabled = false;
        } catch (e) {
            actionBtn.disabled = true;
            setStaffStatusUI({employeeName: null});
            setResult("❌ Network error (status staff)");
        }
    }

</script>


</body>
</html>
